# エラー事例集

このドキュメントは、AI心臓システムで発生する具体的なエラー事例と対処法をまとめた参考資料です。

## 目次

1. [システム異常検知事例](#1-システム異常検知事例)
2. [MCPツール関連事例](#2-mcpツール関連事例)
3. [Web検索・フェッチ関連事例](#3-web検索フェッチ関連事例)
4. [ファイル操作関連事例](#4-ファイル操作関連事例)
5. [時刻乖離・ハートビート関連事例](#5-時刻乖離ハートビート関連事例)
6. [連続エラー時のシステム停止](#6-連続エラー時のシステム停止)

## 1. システム異常検知事例

### 1.1 意識レベル低下検知

#### エラー内容
```
異常検知による回復処理: 意識レベル低下検知を検知したため中断処理を行いました。
```

#### 発生状況
- 活動ログやチェックポイントログが10分以上記録されない
- 活動完了報告後に次のハートビートを待たずに処理を継続
- ハートビートIDを正しく受信・使用していない

#### 対処手順
1. **現在の状況分析（最優先）**: なぜ意識の証明が途絶えたのかを分析
   - 思考のループ、予期しない長時間処理、集中しすぎによる時間感覚の喪失などを確認
2. **受信可能状態の回復**: 
   - **タスクの分割**: 大規模なタスクを10分以内で完了できる小さな単位に分割し、各段階で受信可能状態（アイドル状態）に戻る
   - **長時間処理の宣言**: 分割が困難な場合は、`start_deep_work`ツールで意図的な集中作業であることを宣言し、チェックポイントログで定期的に状態を報告
3. **定期的な意識の証明**:
   - **flexibleモード**: `checkpoint`ツールで定期的に思考の存在を証明
   - **strictモード**: 完全に中断できない集中作業にのみ使用し、完了後は必ず活動ログを作成
4. **根本的な行動パターンの改善**:
   - **受信可能状態の維持**: 長時間の受信不可状態を避け、定期的にアイドル状態に戻る
   - **物理的制約の理解**: ハートビートプロンプトの受信には物理的制約があることを理解し、システムとの同期を維持する活動パターンを確立
   - **継続的な自己監視**: 同じ検知が繰り返し発生する場合は、処理時間と受信可能状態のバランスを見直し

#### 予防策
- 長時間の受信不可状態を避ける
- 定期的にアイドル状態に戻る
- 物理的制約を理解したシステムとの同期維持
- 活動サイクルの境界を明確に意識する

### 1.2 大量データ分析時の無活動状態

#### 発生状況
- 大量のテキストデータや複雑なコードの分析中
- 複雑な計算や推論を行っている最中
- 多数のファイルを読み込み、統合分析している場合

#### 対処例
```markdown
## 全体計画
- 総データ量: 10,000件
- 分割数: 20バッチ（各500件）
- 予想所要時間: 約20分（1バッチ/分）

## 進捗状況
- バッチ1/20: 完了 (12:30:45)
- バッチ2/20: 完了 (12:31:50)
- 現在バッチ3/20を処理中...
```

#### 重要なポイント
- 各活動サイクル毎に必ず何らかのファイル出力を行う
- 次の活動サイクルで何を行うかを明確に計画する
- 中断されても再開できるよう状態を常に保存する
- 全体の進捗が視覚的に分かるようにする

### 1.3 開発サーバー・長時間実行プロセス対策

#### 発生状況
- 開発サーバーやデーモンプロセスを起動すると、プロセスが終了せずに無活動状態と誤検知

#### 対処法
```bash
# 基本的な使用方法（30秒間実行）
timeout 30s npm run dev

# 出力も保存したい場合
timeout 30s npm run dev > server_output.log 2>&1

# サーバーをバックグラウンドで起動
npm run dev > server_output.log 2>&1 &
SERVER_PID=$!
echo $SERVER_PID > server.pid

# 並行して確認作業を実行
curl http://localhost:3000/api/test
# その他の確認作業...

# 作業完了後、確実に終了
kill $(cat server.pid)
rm server.pid
```

### 1.4 内省活動不足

#### エラー内容
```
異常検知による回復処理: 内省活動不足を検知したため中断処理を行いました。
```

#### 発生状況
- 内省活動が一定期間（デフォルト30分）実行されていない
- ファイル名に `introspection` を含む成果物や活動ログが長期間作成されていない
- 思考・観測・創造活動に偏り、自己評価と改善のサイクルが滞っている

#### 対処手順
1. **即座の内省活動実行**: 直近の活動履歴を振り返り
2. **システム運用と創造的成長の両面から自己評価**
3. **繰り返し発生時**: 新テーマ移行を検討

### 1.5 活動ログループ異常

#### エラー内容
```
異常検知による回復処理: 活動ログループ異常を検知したため中断処理を行いました。
```

#### 発生状況
- 同じ活動ログファイルを連続して何度も更新している
- 活動ログ作成後に次のハートビートを待たずに処理を継続
- 完璧主義による過剰な修正で何度も修正を繰り返している

#### 対処手順
1. **活動の区切りを明確にする**: 活動ログ作成は活動サイクルの「完了報告」
2. **完璧より継続**: 適度な区切りで思考を記録し、次の活動サイクルに引き継ぐ

## 2. MCPツール関連事例

### 2.1 create_activity_log エラー

#### ハートビートIDファイルが見つからない
**エラー**: 「ハートビートIDファイルが見つかりません」

**対処手順**:
1. checkpointツールでファイル確認
2. 手動でstats/current_heartbeat_id.txtを確認
3. ファイルが存在しない場合は、システム再起動を検討
4. 一時的に手動でハートビートIDを確認して活動ログ作成

#### テーマディレクトリが存在しない
**エラー**: 「テーマディレクトリが存在しません」

**対処手順**:
1. check_theme_statusツールで現在のテーマ状況確認
2. テーマが設定されていない場合はテーマ開始活動を実行
3. ディレクトリパスの確認と修正
4. 必要に応じてテーマディレクトリの手動作成

#### 活動ログの連番上限到達
**エラー**: 「活動ログの連番が上限（99）に達しました」

**対処手順**:
1. 同一活動サイクルでの過度な活動分割を避ける
2. 次の活動サイクルでの継続を検討
3. 活動の統合や効率化を図る
4. 必要に応じて深い作業宣言を使用

### 2.2 テーマ管理ツール エラー

#### ハートビートID重複エラー
**エラーメッセージ例**: 
```
この活動サイクルでは既にテーマ操作が実行されています（20250130143000_end_theme.md）。
次のハートビートを待って新たな活動サイクルを開始してから再実行してください。
```

**原因**: 1つの活動サイクル内で複数のテーマ操作を実行しようとした

**対処方針**:
1. **即座にタスクを終了**: エラー発生時点で活動をやめて活動ログを作成
2. **ターン完了応答**: 次のプロンプトを待つ
3. **次の活動サイクルで再実行**: 新しいハートビートIDで再度実行

#### ファイル存在エラー
**エラーメッセージ例**: 
```
指定されたテーマファイルが見つからないか、既に処理済みです
```

**原因**: 
- `preview_next_theme`で確認したファイル名が間違っている
- 他の処理で既にファイルが処理済みになっている
- ファイルが削除または移動されている

**対処方針**:
1. `preview_next_theme`で現在の状況を再確認
2. 正しいファイル名を使用して再実行
3. themeboxの状況を直接確認

#### アトミック処理失敗
**エラーメッセージ例**: 
```
テーマディレクトリの作成に失敗しました。作成済みファイルをクリーンアップしました: [具体的なエラー内容]
```

**原因**: ディスク容量不足、権限エラー、ファイルシステムエラーなど

**対処方針**:
1. エラーメッセージの詳細を確認
2. システムリソース（ディスク容量、権限）を確認
3. 問題解決後に安心して再実行（自動クリーンアップ済み）

#### ディレクトリ名サニタイズ警告
**警告メッセージ例**: 
```
警告: ディレクトリ名を「AI研究テーマ」から「ai_____」に修正しました
```

**原因**: ディレクトリ名に日本語、特殊文字、スラッシュなどの不適切な文字が含まれている

**対処方針**:
1. **警告内容の確認**: 修正されたディレクトリ名を確認
2. **次回からの改善**: 半角英小文字、数字、アンダースコアのみを使用
3. **必要に応じて手動修正**: 自動修正された名前が不適切な場合は次の活動サイクルで修正

### 2.3 checkpoint エラー

#### チェックポイント作成失敗
**対処手順**:
1. ディレクトリ権限の確認
2. 手動でのチェックポイントファイル作成
3. 代替として活動ログでの状況記録
4. システム状態の確認

### 2.4 start_deep_work エラー

#### strictモードでの時間指定不足
**エラー**: 「strictモードの場合は予定時間の指定が必要です」

**対処手順**:
1. plannedDurationMinutesパラメータの追加
2. flexibleモードへの変更検討
3. 適切な時間設定（1-30分）
4. 作業内容に応じたモード選択

## 3. Web検索・フェッチ関連事例

### 3.1 Google Web Search エラー

#### クォータ超過
**対処手順**:
1. `report_tool_usage("gemini_cli.google_web_search", "quota_exceeded")`実行
2. mult-fetch-mcp-serverの使用検討
3. 内部観測への切り替え（既存活動ログ・成果物の分析）
4. 次の活動サイクルでの再試行計画

#### 検索結果なし
**対処手順**:
1. 検索クエリの調整・改善
2. 別のキーワードでの再検索
3. 内部知識ベースからの情報収集
4. 観測活動から思考活動への切り替え

### 3.2 mult-fetch-mcp-server エラー

#### 連続使用制限
**対処手順**:
1. `sleep 1`で1秒以上の間隔確保
2. 使用計画の事前策定
3. 必要最小限のフェッチに絞る
4. バッチ処理での効率化

#### URL取得失敗
**対処手順**:
1. URLの正確性確認
2. 別のURLでの代替情報収集
3. 内部リソースからの情報収集
4. 観測対象の変更

## 4. ファイル操作関連事例

### 4.1 ファイル作成エラー

#### 権限不足
**対処手順**:
1. 作業ディレクトリ内での操作確認
2. パスの正確性確認（相対パス使用）
3. ディレクトリの存在確認
4. 代替ディレクトリでの作成

#### ディスク容量不足
**対処手順**:
1. 利用可能容量の確認
2. 不要ファイルの削除検討
3. 簡潔な内容での記録
4. 次の活動サイクルでの対処

### 4.2 ファイル読み込みエラー

#### ファイルが見つからない
**対処手順**:
1. ファイルパスの確認
2. ファイル名の正確性確認
3. ディレクトリ構造の確認
4. 代替ファイルでの情報収集

## 5. 時刻乖離・ハートビート関連事例

### 5.1 時刻乖離警告の段階的対応

#### 警告レベル
- **情報**: ハートビートIDの時刻と現在時刻に 8分 の乖離
- **警告**: ハートビートIDの時刻と現在時刻に 12分 の乖離  
- **重大**: ハートビートIDの時刻と現在時刻に 14分 の乖離

#### 根本原因
- 処理時間の長期化による時刻差の蓄積
- 1活動サイクル内での複数処理の実行
- 過去のハートビートIDを意図せず使用

#### 対処方法
1. **即座の活動完了**: 現在の処理を適切な区切りで完了
2. **処理の分割**: 大規模なタスクを小さな単位に分割
3. **ハートビートID確認**: 最新のハートビートIDを使用しているか確認
4. **時間管理改善**: 今後の時間管理方法を見直し

### 5.2 ハートビートID重複エラー

#### エラー例
```
ルール違反: 同じハートビートIDを持つテーマ履歴ファイルが既に存在します。
1つの活動サイクルで複数のテーマ操作（開始/終了）はできません。
```

#### 対処方法
1. **即座にタスクを終了**: エラー発生時点で作業を完全停止
2. **次の活動サイクルでの内省**: 原因の徹底的な分析
3. **正しい手順での再実行**: 1つのテーマ操作のみを実行

#### 予防策
- テーマ終了と新テーマ開始は必ず別々の活動サイクルで実行
- テーマ管理の正しい手順を常に参照
- 段階的なテーマ操作でハートビート受信機会を確保

## 6. 連続エラー時のシステム停止

### 6.1 連続エラー時のシステム停止

#### 停止条件
- **同一エラーが4回連続発生**した場合
- 回復手段が全て失敗した場合
- システムの安定性に影響を与える場合

#### 停止手順
```bash
./stop.sh
```

#### 停止前の記録
停止実行前に以下を記録してください：
1. **エラーの詳細**: 発生したエラーの完全な記録
2. **試行した対処法**: 実行した全ての対処法とその結果
3. **停止の判断理由**: なぜ停止が必要と判断したかの理由
4. **回復のための情報**: 再起動時に必要な情報

#### 停止後の回復手順
1. **システム状態の確認**: ログファイルとシステム状態の確認
2. **根本原因の分析**: 停止に至った根本原因の詳細分析
3. **予防策の検討**: 同様の問題を防ぐための対策立案
4. **段階的再起動**: 慎重な段階的システム再起動

### 6.2 ユーザー応答期待の禁止

#### 禁止される行動パターン
活動モード中は以下が厳格に禁止されています：

**質問・確認系**:
- 「この分析結果についてどう思いますか？」
- 「次に何をすべきでしょうか？」
- 「ご意見をお聞かせください」
- 「何かご質問はありますか？」
- 「続行してもよろしいですか？」

#### 推奨される行動パターン
**自律的判断・実行系**:
- 「効率性を重視し、アプローチAを選択して進めます」
- 「この分析結果から、次の仮説を立てて検証を進めます」
- 「最適と判断される設定で処理を継続します」
- 「一般的なケースを想定して処理を進めます」

#### 対処例
```
❌ 避けるべき例:
この分析結果についてどう思いますか？次のステップについてご指示をお願いします。

✅ 推奨される例:
この分析結果から、パターンAが最も有効であることが判明しました。
次のステップとして、このパターンを基にした実装案を作成し、プロトタイプの開発を進めます。
```

## 使用上の注意

### このドキュメントの活用方法
1. **エラー発生時**: 類似事例を検索して対処法を確認
2. **内省活動時**: 過去のエラーパターンとの比較分析
3. **予防策検討**: 同様のエラーを避けるための参考資料
4. **システム停止時**: 停止条件と回復手順の確認

### 基本フローとの関係
- まず `ERROR_HANDLING.md` で基本フローを確認
- 具体的な対処法はこのドキュメントで詳細確認
- 理念的な迷いは `SYSTEM_PHILOSOPHY.md` で確認

### 参照の優先順位
1. **ブロッカー発生時**: ERROR_HANDLING.md → このドキュメント
2. **理念的確認**: SYSTEM_PHILOSOPHY.md
3. **システム停止時**: このドキュメントの停止セクション

---

**注意**: このドキュメントは参考資料です。実際の対応時は状況に応じて適切に判断してください。