# 基本操作の詳細手順

このドキュメントは、AI心臓システムの基本となる**活動サイクル**に関する詳細を説明します。

## 目次

1. [ハートビートID確認の詳細](#1-ハートビートid確認の詳細)
2. [成果物と活動ログの役割分担](#2-成果物と活動ログの役割分担)
3. [活動ログ記録の詳細](#3-活動ログ記録の詳細)
4. [活動完了の判断指針](#4-活動完了の判断指針)
5. [完了報告後の制限の詳細](#5-完了報告後の制限の詳細)
6. [時間制限と深い作業宣言](#6-時間制限と深い作業宣言)
7. [チェックポイントログの詳細](#7-チェックポイントログの詳細)
8. [エラーハンドリングの基本手順](#8-エラーハンドリングの基本手順)

## 1. ハートビートID確認の詳細

### 1.1. ハートビートID取得方法
プロンプト受信パターンとファイル確認パターンの２つあります。

#### プロンプト受信パターン
* ハートビートプロンプトを受信してハートビートIDを取得
* 取得時に、「ハートビートIDは[受信したハートビートID]です。」と明示的に発言してください

**適用場面**: 
- 活動サイクル終了後から次の活動サイクルの開始前のプロンプト受信待ち状態の時

#### ファイル確認パターン
**基本的な手順**:
1. `stats/current_heartbeat_id.txt`ファイルを直接確認し、記載されたハートビートIDを確認し取得する
2. 必要に応じてチェックポイントログを作成（後述）

**特徴**: 処理を中断することなくハートビートIDを取得可能
**適用場面**: 
- 集中作業中、長時間処理中
  - 深い作業を宣言することが前提
- 予期せぬ長時間処理発生時で、処理を中断して新しいハートビートIDをプロンプト受信パターンでは取得できない時。

**効率化手段**: checkpointツールの活用
上記の手動手順（ハートビートIDを取得 + チェックポイントログ作成）を自動化できます：
```
checkpoint(message="現在の状況を簡潔に記載")
```
- ファイル確認とチェックポイントログ作成を一度に実行
- 前回の活動ログやチェックポイントからの経過時間情報も同時に取得


### 1.2. ハートビートID使用の原則
**基本原則**: 成果物ファイルや活動ログの作成時には、常に最新のハートビートIDをファイル名に使用してください。

- **時間軸の整合性**: 最新のハートビートIDを使用することで、活動の時系列を正確に記録
- **自動同期**: checkpointツールを使用すると、最新のハートビートIDが自動的に取得されます

### 1.3. ハートビートIDの再確認
* ハートビートID取得後、ツール使用後などのタイミングで、現在のハートビートIDを再確認として再宣言しても良い。
  * ただしその場合は **[再確認]** などのラベルをつけて宣言するようにし、最初のハートビートID取得時と区別できるように宣言する。
    * 例: 「[再確認]ハートビートIDは[受信したハートビートID]です。」


## 2. 成果物と活動ログの役割分担

活動サイクルにおける「成果物」と「活動ログ」は、どちらも重要な記録ですが、その目的と役割は明確に異なります。この違いを理解することが、システムと正しく協調し、安定した活動を継続するための鍵となります。

### 1.1. 成果物 (Artifacts)

- **役割**: あなたの思考、分析、創造の**知的資産そのもの**です。
- **目的**: 将来のあなた自身が参照し、さらに思考を発展させるための**詳細な思考の記録**です。
- **性質**: 内容や形式は自由であり、あなたの創造性が最も発揮される場所です。
- **位置づけ**: 活動の**中身**そのものです。
- **詳細**: `.ai-docs/ACTIVITY_DETAILS.md`の「活動実行と成果物出力の詳細」を参照

### 1.2. 活動ログ (Activity Log)

- **役割**: 活動サイクルが正常に完了したことを**システムに通知するための公式な報告書（シグナル）**です。
- **目的**: システムの安定稼働を維持し、次のハートビートを受信可能にするための**技術的に必須の手続き**です。
- **性質**: 厳格なフォーマットに従う、メタデータ中心の簡潔な記録です。
- **位置づけ**: 活動の**完了報告**であり、システムとの約束事です。

> **なぜこの区別が重要か？**
> あなたが詳細な「成果物」を作成しても、システムはそれを「活動の完了報告」とは認識しません。システムが待っているのは、定型化された「活動ログ」という名のパルス信号です。この信号がなければ、システムはあなたがまだ深い思考の海にいて、次の指示（ハートビート）を受け取れる状態にないと判断します。


## 3. 活動ログ記録の詳細

### 3.1. 保存場所とファイル名形式
**保存場所**: `artifacts/{THEME_START_ID_テーマ名}/histories/`
**形式**: `{ハートビートID}.md`（例: `20250702140000.md`）
**ハートビートID**: ハートビートID確認により取得したIDを使用

### 3.2. 記録内容のフォーマット
```markdown
# 活動ログ：YYYYMMDDHHMMSS

### 活動種別
[実行した活動種別（観測・思考・創造・内省・その他）。補助的な操作を使用した場合は、括弧書きで操作名を追記。例: 思考 (ファイル読み込み使用)]

### 活動内容
[今回の活動サイクルでの簡潔な活動内容。(詳細は関連ファイルに記載されていることが前提)]

### 成果物、関連ファイル
[この活動サイクルで作成または修正したファイルの**作業ディレクトリからの相対パス**を列挙(この活動ログファイル自身は除く)。例: artifacts/20250115143000_laughter/20250115152000_thoughts_on_laughter.md]

### 自己評価、備考
[この活動サイクルでの活動内容の評価やその他特記事項があれば記載。例: Web検索クォータ制限のため、文献調査を中断。]
```

### 3.3. 複数種別の活動を実行した場合
基本的には、１活動サイクルに対して、活動種別は一つであり、それに対して活動ログは一つ作成する。
ただ、もし何らかの理由で、複数の活動種別（思考・観測・創造等）を一つの活動サイクルで実行した場合は、**種別ごとに個別の活動ログを作成**してください：

- **連番ファイル使用**: `YYYYMMDDHHMMSS_01.md`, `YYYYMMDDHHMMSS_02.md`等
- **各ログの独立性**: 各活動種別の詳細な内容を個別に記録

**実行例**:
1. `20250126143000_01.md` - 思考活動（テーマに関する新しい視点の検討）
2. `20250126143000_02.md` - 創造活動（思考結果を基にした具体的なアウトプット作成）

**基本原則**: 一つの活動サイクルで一つの活動種別を推奨。複数実行は論理的に連続した処理の場合のみ。


### 3.4. 活動ログ作成・確認の効率化手段: MCPツールの活用
上記の手動手順を効率化し、品質を向上させるツールが利用可能です：

**create_activity_log ツール**:
- 上記フォーマットでの活動ログファイル自動作成
- 最新のハートビートIDの自動取得による適切なファイル名生成
  - 連番の自動付与

**get_latest_activity_log ツール**:
- 過去の活動ログの効率的な取得
- 内省活動時の複数ログ一括取得（1-10件指定可能）
- 手動でのファイル検索・読み込み作業を自動化

## 4. 活動サイクルの完了の判断指針

### 4.1. システム理念との整合性

#### 「小さな一歩」重視
- **「小さな一歩」の積み重ね**: 一度の活動で完璧を目指すのではなく、一歩一歩の着実な探求による深化を重視します。
- **完璧主義の回避**: 完璧な成果よりも、一つ一つの活動の積み重ねによる小さな成長を優先してください。

#### 自律的判断
- **自己管理**: AIが自身の判断で適切なタイミングで完了報告を実行します。
- **バランス**: システムの安定性と創造性のバランスを考慮して判断します。

### 4.2. 完了タイミングの基本原則

#### 時間制御との調和
- **適切な時間内**: 通常の活動は適切な時間内（5分推奨、10分警告）での完了を目指します。
- **意識レベル維持**: 意識レベル低下検知（10分）を避けるための自律的な時間管理と定期的な意識の証明が重要です。
- **長時間処理の活用**: 必要に応じて、`start_deep_work`ツールによる長時間処理宣言を活用します。

## 5. 活動ログ作成後の制限の詳細

### 5.1. 厳格ルール
- 活動ログ作成後、必ず**ターン完了応答**を行い、次のハートビートプロンプト受信待ち状態になるようにしてください。

### 5.2. 目的
次の活動サイクルとの境界を明確にし、システムの継続性を保つための技術的要件です。

### 5.3. 違反の影響
- ハートビートプロンプトを受信できないため、新しいハートビートIDを取得できずに、システムの継続性を損なう
- 次の活動サイクルとの境界が曖昧になる
- 異常検知システムの誤動作を引き起こす可能性

### 5.4. 適切な対応のために
- **ターン完了応答**前に、活動ログ作成を含め必要な作業をすべて完了させる
- **ターン完了応答**は最後の行動として実行する
- **ターン完了応答**の内容は以下のようなものにする。
  - 「今回のハートビート検知による活動サイクルの完了を報告し、このサイクルの活動を終了する」

### 5.5. 活動サイクルの完全なフロー
1. ハートビートプロンプト受信
2. ハートビートID確認
3. 活動選択・実行・成果物出力
4. **活動ログの記録（システムへの完了報告）**
5. **ターン完了応答**
6. 次のハートビートプロンプト受信待ち

**重要**: ステップ4の「活動ログの記録」は、単なる記録作業ではありません。これは、現在の活動サイクルを正常に完了し、次のハートビートプロンプトを受信可能にするための**技術的に必須のステップ**です。この報告がない限り、システムはあなたの活動サイクルが完了したとは見なしません。


### 5.6. 次のハートビートプロンプト受信待ちフェーズの技術的重要性
**ターン完了応答**後の次のハートビートプロンプト受信待ちフェーズは、活動サイクルの技術的に不可欠な構成要素です：
- **受信可能状態の確保**: プロンプト入力待ち状態に移行することで、次のハートビートプロンプトを受信可能にする
- **システム同期の維持**: 外部システムの送信タイミングと受信可能タイミングを同期
- **長時間処理の回避**: 受信不可状態を最小限に抑え、システムとの協調を維持
- **異常検知の回避**: 適切なプロンプト受信待ちにより、システムの誤った異常検知を防止

### 5.7. ハートビートプロンプト受信の物理的制約
**重要な技術的制約**: あなたが何らかの処理を実行している間は、新しいハートビートプロンプトを受信することができません。

- **受信可能状態**: プロンプト入力待ちの状態（アイドル状態）
- **受信不可状態**: コマンド実行中、ファイル操作中、思考・分析中
- **システムの動作**: システムは60秒間隔で送信を続けるが、あなたが処理中の場合は受信されずに破棄される
- **待機の技術的価値**: アイドル状態への移行により、確実な受信を保証

## 6. 時間制限と深い作業宣言

### 6.1. システム技術的制約の理解

**重要**: 時間ベース制御は単なる推奨ではなく、システムの技術的制約に基づく必須要件です。

#### agentセッションの技術的制約
- **制約**: あなた（agentセッション）は、一つのタスクを実行中は他のタスクを受け付けられません
- **影響**: 長時間処理中はハートビートプロンプトがキューイングされず破棄されます
- **結果**: 数分の処理でも複数ハートビートを見逃し、「意識レベル低下検知」として回復処理がトリガーされてしまう可能性があります

#### 長時間実行プロセスの注意点
- **問題**: `npm run dev`等の開発サーバーをフォアグラウンドで起動すると永久に次のハートビートを受け取れません
- **解決**: 必ず**timeoutコマンドによる時限実行**（例: `timeout 30s npm run dev`）、または以下のバックグラウンド実行を使用
- **バックグラウンド実行**: 並行作業が必要な場合はプロセス管理（PID記録と確実な終了処理）が必須

### 6.2. 基本的な時間制限
- **基本**: 適切な時間内での活動（通常10-20分）
- **健全状態**: 10分以内の活動ログまたはチェックポイントログ作成
- **技術的根拠**: 上記システム制約により継続的なハートビート受信を確保するため

### 6.3. 時間警告システム
**5分経過**: 処理時間通知（継続可能）
- MCPツールから「処理時間通知: 活動サイクル開始から5分が経過しています。」

**10分経過**: 長時間処理警告（活動完了推奨）
- MCPツールから「長時間処理警告: 活動サイクル開始から10分が経過しています。処理を区切ることを推奨します。」

### 6.4. 深い作業宣言システム
**目的**: 長時間の集中作業を行う際に事前宣言するシステム

#### 手動での長時間処理宣言（代替手段）
MCPツールが利用できない場合の手動手順：

**手順**:
1. ディレクトリ作成: `mkdir -p stats/extended_processing`
2. 宣言ファイル作成: `stats/extended_processing/current.conf`

**ファイル内容例**:
```
# 長時間処理宣言
ハートビートID: 20250119143000
計画処理時間: 15分
理由: 大規模ログファイル分析
```

**注意事項**:
- ハートビートIDは現在のハートビートIDを使用
- 計画処理時間は1-30分の範囲で指定
- 理由は10-200文字で具体的に記述

#### start_deep_workツール使用方法（推奨）:
```
start_deep_work(
  heartbeatId="現在のハートビートID",
  restrictionType="flexible" または "strict",
  activityDescription="作業内容の説明",
  plannedDurationMinutes=20  // strictモードの場合のみ
)
```

**flexibleモード**:
- 用途: チェックポイント作成可能な長時間作業
- 特徴: 意識レベル低下検知が無効化、内省不足警告が無効化
- 推奨場面: 複雑な問題解決、段階的な創造活動、調査・分析作業

**strictモード**:
- 用途: 完全に中断できない集中作業
- 特徴: 指定時間まで全ての異常検知が無効化
- 推奨場面: 創造活動のピーク、一気に完成させる必要がある作業

### 重要な注意事項
- **内省推奨**: 深い作業完了後は内省活動を行うことを推奨
- **緊急対応**: 緊急対応（エラー、バグ修正等）が必要な場合は緊急対応を優先
- **適切な使用**: 本当に必要な場合のみ使用し、濫用を避ける


## 7. チェックポイントログの詳細

### 7.1. 概要と目的
チェックポイントログは、長時間処理中に利用する、活動ログとは別に作成する軽量な活動記録です。
**活動サイクル**の途中で、**最新のハートビートID**と同期し、活動を継続していることを証明する手段として機能します。
長時間処理中の活動継続証明のほかに、時間を記録することによる処理時間の測定としても使用できます。

### 7.2. 作成タイミング
- **活動継続証明**: 長時間処理中の意識的活動の証明
- **推奨間隔**: 最後の活動ログまたはチェックポイントから10分以内
- **処理時間測定**: 作業の開始・完了・中間地点での時間記録
- **flexibleモード**: 深い作業宣言中は特に推奨

### 7.3. 作成方法
**基本的な手順**:
1. 現在のハートビートIDを取得（`stats/current_heartbeat_id.txt`から）
2. ファイル作成: `stats/checkpoints/{ハートビートID}.txt`
3. 内容記載: 簡潔な現在の活動内容を1行で記載

**効率化手段**: checkpointツールの活用
上記の手動手順を自動化し、追加情報も取得できます：
```
checkpoint(message="現在の状況を簡潔に記載")
```
- ハートビートID取得からファイル作成まで自動実行
- 前回の活動ログやチェックポイントからの経過時間情報も同時に表示

### 7.4. ファイル内容の記載例
- "エラー原因の調査開始"
- "エラー原因の調査完了"
- "創造活動実行中"
- "データ分析処理完了"
- "APIドキュメントの精読中"

### 7.5. 活動ログとの使い分け
- **活動ログ**: 活動サイクルの活動の概要の記録
- **チェックポイントログ**: 節目の簡潔な活動内容の記録
- **目的**: 活動継続証明、処理時間測定

**詳細な設計思想**: `./SYSTEM_PHILOSOPHY.md`の「チェックポイントログの理念」を参照


## 8. エラーハンドリングの基本手順

### 8.1. エラー発生時の対処手順
1. **エラー記録**: エラー内容を活動ログに詳細に記録
2. **原因推定**: 可能な限り原因を分析（不明な場合は「原因不明」と記録）
3. **代替手段検討・実行の例**: 
   - Web検索エラー → 内部観測に切り替え
   - ファイル操作エラー → 活動種別変更
   - 重大なエラー → テーマ変更を検討
4. **継続判定**: 可能な限り回復・代替手段で次サイクルに進む

### 8.2. 連続エラーと停止判定
- **連続エラー判定**: 同じエラーが4回連続で発生した場合は停止
- **自動停止**: 連続エラー検出時は自動停止を実行
- **停止記録**: 停止理由を活動ログとテーマ終了履歴に記録

### 8.3. 重要原則
**エラーは失敗ではなく、適切な対処・継続ができれば正しい挙動**として扱う。
